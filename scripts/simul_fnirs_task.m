% Script generated by Brainstorm (12-Mar-2025)

% Input files -- resting state data after pre-processing
sFiles = { 'sub-02/sub-02_task-rest_run-01_pipeline-preproc/data_block001.mat'};


% Start a new report
bst_report('Start', sFiles);

scouts = {'FOV_copy.1', 'FOV_copy.2', 'FOV_copy.3', 'FOV_copy.4', 'FOV_copy.5', 'FOV_copy.6', 'FOV_copy.8', 'FOV_copy.9', 'FOV_copy.10', 'FOV_copy.11', 'FOV_copy.12', 'FOV_copy.13', 'FOV_copy.14', 'FOV_copy.15', 'FOV_copy.16', 'FOV_copy.17', 'FOV_copy.18', 'FOV_copy.19', 'FOV_copy.20', 'FOV_copy.21', 'FOV_copy.22', 'FOV_copy.23', 'FOV_copy.24', 'FOV_copy.25', 'FOV_copy.26', 'FOV_copy.27', 'FOV_copy.28', 'FOV_copy.29', 'FOV_copy.30', 'FOV_copy.31', 'FOV_copy.32', 'FOV_copy.33', 'FOV_copy.34', 'FOV_copy.35', 'FOV_copy.36', 'FOV_copy.37', 'FOV_copy.38', 'FOV_copy.39', 'FOV_copy.40', 'FOV_copy.41', 'FOV_copy.42', 'FOV_copy.43', 'FOV_copy.44', 'FOV_copy.45', 'FOV_copy.46', 'FOV_copy.47', 'FOV_copy.48', 'FOV_copy.49', 'FOV_copy.50', 'FOV_copy.51', 'FOV_copy.52', 'FOV_copy.53', 'FOV_copy.54', 'FOV_copy.55', 'FOV_copy.56', 'FOV_copy.57', 'FOV_copy.58', 'FOV_copy.59', 'FOV_copy.60', 'FOV_copy.61', 'FOV_copy.62'};

start   = 10;
n_scout = 1;

% Process: Simulate NIRS signal
sFiles = bst_process('CallProcess', 'process_nst_simul_nirs', sFiles, [], ...
    'method',            'task', ...  % Task
    'sim_name',          'simulation_wake_task_1db_small_test', ...
    'SNR',               1, ...
    'scouts',            {'User scouts', scouts(start:(start+n_scout-1))}, ...
    'thresh_dis2cortex', 3);

baselinewindow_avg   = [-10 0];
timewindow_avg       = [-10 30];

baselinewindow_full  = [20 40];
timewindow_full      = [20 340];

neighborhood_order   = [4 , 5, 6, 8];

for iFile = 1:length(sFiles)

   sImput = sFiles(iFile);


   %% Case 1: we low-pass, then average, then localize.

    % Process: Low-pass:0.1Hz
    sFile = bst_process('CallProcess', 'process_bandpass', sImput, [], ...
        'sensortypes', 'nirs', ...
        'highpass',    0, ...
        'lowpass',     0.1, ...
        'tranband',    0.05, ...
        'attenuation', 'relax', ...  % 40dB (relaxed)
        'ver',         '2019', ...  % 2019
        'mirror',      0, ...
        'overwrite',   0);
    
    % Process: Windows Average: [-10.000s,30.000s]
    sFileAvg = bst_process('CallProcess', 'process_windows_average_time', sFile, [], ...
        'Eventname',      'Task', ...
        'timewindow',     timewindow_avg, ...
        'remove_DC',      1, ...
        'baselinewindow', baselinewindow_avg, ...
        'overwrite',      0);


    % Generate the average ground truth 
    [sStudy, iStudy, iResults] = bst_get('ResultsForDataFile', sImput.FileName);
    ResultFiles = sStudy.Result(iResults);
    

    % Select Ground truth and cMEM
    sMaps = ResultFiles( contains({ResultFiles.Comment}, {'Ground Truth'}));
    bst_process('CallProcess', 'process_windows_average_time', sMaps.FileName, [], ...
            'Eventname',      'Task', ...
            'timewindow',     timewindow_avg, ...
            'remove_DC',      1, ...
            'baselinewindow', baselinewindow_avg, ...
            'new_dataFIle', sFileAvg.FileName, ...
            'overwrite',      0);

    

    for iNBO = 1:length(neighborhood_order)
        compute_cMEM(timewindow_avg, baselinewindow_avg, neighborhood_order(iNBO), sFileAvg);
    end

    % Process: Source reconstruction - wMNE
    bst_process('CallProcess', 'process_nst_wmne', sFileAvg, [], ...
                                                    'thresh_dis2cortex',  5, ...
                                                    'depth_weightingMNE', 0.3, ...
                                                    'TimeSegment',        timewindow_avg, ...
                                                    'NoiseCov_recompute', 1, ...
                                                    'TimeSegmentNoise',   baselinewindow_avg);




   %% Case 2: Localize then average

   compte_MNE(sImput, timewindow_full, baselinewindow_full, timewindow_avg, baselinewindow_avg, sFileAvg);

    for iNBO = 1:length(neighborhood_order)

        selected_scales = [3:8]; alpha_init = 7; normalization = 'fixed';
        compute_wMEM(sImput, timewindow_full, baselinewindow_full, neighborhood_order(iNBO), selected_scales, alpha_init, normalization, timewindow_avg, baselinewindow_avg, sFileAvg);
        
        selected_scales = [6:8]; alpha_init = 7; normalization = 'fixed';
        compute_wMEM(sImput, timewindow_full, baselinewindow_full, neighborhood_order(iNBO), selected_scales, alpha_init, normalization,  timewindow_avg, baselinewindow_avg, sFileAvg);

    end

end


% Save and display report
ReportFile = bst_report('Save', sFiles);
bst_report('Open', ReportFile);


function compute_wMEM(sImput, timewindow_full, baselinewindow_full, neighborhood_order, selected_scales, alpha_init, normalization, timewindow_avg, baselinewindow_avg, sFileAvg)


    mem_option = be_pipelineoptions([], 'wMEM','NIRS');
    mem_option.optional = struct_copy_fields(mem_option.optional, ...
        struct(...
        'TimeSegment',    timewindow_full, ...
        'BaselineType',    {{'within-data'}}, ...
        'BaselineHistory', {{'within'}}, ...
        "baseline_shuffle", 0, ...
        "BaselineSegment", baselinewindow_full , ...
        'display',         0));

    mem_option.clustering =  struct_copy_fields(mem_option.clustering, ...
        struct( ...
        'neighborhood_order',   neighborhood_order));

    mem_option.wavelet.selected_scales  = selected_scales;
    mem_option.model.alpha_method       = alpha_init;
    mem_option.optional.normalization   = normalization;

    sFilesMEM = bst_process('CallProcess', 'process_nst_cmem', sImput, [], ...
        'mem', struct('MEMpaneloptions', mem_option), ...
        'thresh_dis2cortex',       5, ...
        'NoiseCov_recompute',      1, ...
        'auto_neighborhood_order', 0, ...
        'store_sparse_results',    0);

    sFilesMEM =  bst_process('CallProcess', 'process_add_tag', sFilesMEM, [], ...
        'tag',            sprintf('| nbo = %d | alpha = %d | norm = %s',  neighborhood_order, alpha_init, normalization), ...
        'output',         'name'); 

    % Process: Windows Average: [-10.000s,30.000s]
    
    bst_process('CallProcess', 'process_windows_average_time', sFilesMEM, [], ...
        'Eventname',      'Task', ...
        'timewindow',     timewindow_avg, ...
        'remove_DC',      1, ...
        'baselinewindow', baselinewindow_avg, ...
        'new_dataFIle', sFileAvg.FileName, ...
        'overwrite',      0);


    % Process: Low-pass:0.1Hz
    sFileBP = bst_process('CallProcess', 'process_bandpass', sFilesMEM, [], ...
        'sensortypes', 'nirs', ...
        'highpass',    0, ...
        'lowpass',     0.1, ...
        'tranband',    0.005, ...
        'attenuation', 'relax', ...  % 40dB (relaxed)
        'ver',         '2019', ...  % 2019
        'mirror',      0, ...
        'overwrite',   0);
    
    bst_process('CallProcess', 'process_windows_average_time', sFileBP, [], ...
        'Eventname',      'Task', ...
        'timewindow',     timewindow_avg, ...
        'remove_DC',      1, ...
        'baselinewindow', baselinewindow_avg, ...
        'new_dataFIle', sFileAvg.FileName, ...
        'overwrite',      0);
end

function compte_MNE(sImput, timewindow_full, baselinewindow_full, timewindow_avg, baselinewindow_avg, sFileAvg)

    % Process: Source reconstruction - wMNE
    sFileMNE = bst_process('CallProcess', 'process_nst_wmne', sImput, [], ...
        'thresh_dis2cortex',  5, ...
        'depth_weightingMNE', 0.3, ...
        'TimeSegment',        timewindow_full, ...
        'NoiseCov_recompute', 1, ...
        'TimeSegmentNoise',   baselinewindow_full);
    
    
    
    % Process: Windows Average: [-10.000s,30.000s]
    bst_process('CallProcess', 'process_windows_average_time', sFileMNE, [], ...
        'Eventname',      'Task', ...
        'timewindow',     timewindow_avg, ...
        'remove_DC',      1, ...
        'baselinewindow', baselinewindow_avg, ...
        'new_dataFIle', sFileAvg.FileName, ...
        'overwrite',      0);
    
    
    % Process: Low-pass:0.1Hz
    sFileBP = bst_process('CallProcess', 'process_bandpass', sFileMNE, [], ...
        'sensortypes', 'nirs', ...
        'highpass',    0, ...
        'lowpass',     0.1, ...
        'tranband',    0.05, ...
        'attenuation', 'relax', ...  % 40dB (relaxed)
        'ver',         '2019', ...  % 2019
        'mirror',      0, ...
        'overwrite',   0);
    
    bst_process('CallProcess', 'process_windows_average_time', sFileBP, [], ...
        'Eventname',      'Task', ...
        'timewindow',     timewindow_avg, ...
        'remove_DC',      1, ...
        'baselinewindow', baselinewindow_avg, ...
        'new_dataFIle', sFileAvg.FileName, ...
        'overwrite',      0);
end

function compute_cMEM(timewindow_avg, baselinewindow_avg, neighborhood_order, sFileAvg)
    mem_option = be_pipelineoptions([], 'cMEM', 'NIRS');
    
    mem_option.optional = struct_copy_fields(mem_option.optional, ...
        struct(...
        'TimeSegment',     timewindow_avg, ...
        'BaselineType',    {{'within-data'}}, ...
        'BaselineSegment', baselinewindow_avg, ...
        'display',         0));
    
    
    mem_option.clustering =  struct_copy_fields(mem_option.clustering, ...
        struct( ...
        'neighborhood_order',   neighborhood_order));
    
    
    sFileMEM = bst_process('CallProcess', 'process_nst_cmem', sFileAvg, [], ...
        'mem', struct('MEMpaneloptions', mem_option), ...
        'thresh_dis2cortex',       5, ...
        'NoiseCov_recompute',      1, ...
        'auto_neighborhood_order', 0, ...
        'store_sparse_results',    0);
    
    
    bst_process('CallProcess', 'process_add_tag', sFileMEM, [], ...
        'tag',            sprintf('| nbo = %d',  neighborhood_order), ...
        'output',         'name'); 
end